describe("my-app", () => {
  it("should initialize cookie and event is sent to CDP", () => {
    cy.intercept("POST", `https://edge-platform.sitecorecloud.io/events/v1.2/events*`).as("eventRequest");
    cy.intercept("POST", `https://edge-platform.sitecorecloud.io/v1/personalize/v2/callFlows*`).as('personalizeRequest');
    
    cy.wait(1000);
    cy.visit("http://localhost:3000");

    cy.getCookie("sc_83d8199c-2837-4c29-a8ab-1bf234fea2d1").then((cookie) => expect(cookie?.value).to.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i));
    cy.get('[data-testid="sendEventBtn"]').click();
    cy.wait("@eventRequest")
      .then((request) => {
        expect(request.request.body.type).to.eq("VIEW");
      })
      .its("response.statusCode")
      .should("eq", 201);

    cy.wait(1000);
    cy.get('[data-testid="sendEventBtnPersonalize"]').click();
    cy.wait("@personalizeRequest")
      .then((request) => {        
        expect(request.request.body.friendlyId).to.eq("personalizeintegrationtest");
      })
      .its("response.statusCode")
      .should("eq", 200);
  });
});
