describe("my-app", () => {
  it("should initialize CloudSDK with events, personalize and search and call the related functions ", () => {
       
    cy.intercept("POST", `https://${Cypress.env("HOSTNAME")}/${Cypress.env("EDGE_PROXY_VERSION")}/events/${Cypress.env("API_VERSION")}/events*`).as("eventRequest");
    cy.intercept("POST", `https://${Cypress.env("HOSTNAME")}/${Cypress.env("EDGE_PROXY_VERSION")}/personalize*`).as("personalizeRequest");
    cy.intercept("POST", `https://${Cypress.env("HOSTNAME")}/${Cypress.env("EDGE_PROXY_VERSION")}/search*`).as("searchRequest");
  
    cy.wait(1000);
    cy.visit("http://localhost:3000");

    cy.getCookie("sc_83d8199c-2837-4c29-a8ab-1bf234fea2d1").then((cookie) => expect(cookie?.value).to.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i));
    cy.get('[data-testid="sendEventBtn"]').click();
    cy.wait("@eventRequest")
      .then((request) => {
        expect(request.request.body.type).to.eq("VIEW");
      })
      .its("response.statusCode")
      .should("eq", 201);

    cy.wait(1000);
    cy.get('[data-testid="sendPersonalizeBtn"]').click();
    cy.wait("@personalizeRequest")
      .then((request) => {        
        expect(request.request.body.friendlyId).to.eq("personalizeintegrationtest");
      })
      .its("response.statusCode")
      .should("eq", 200);

    cy.wait(1000);
    cy.get('[data-testid="sendSearchBtn"]').click();
    cy.wait("@searchRequest")
      .then((request) => {
        expect(request.request.body.context.page.uri).to.eq("/test");
      })
      .its("response.statusCode")
      .should("eq", 200);

    cy.wait(1000);
    cy.get('[data-testid="sendConversionEventBtn"]').click();
    cy.wait("@eventRequest")
      .then((request) => {
        expect(request.request.body.sc_search.data.value.context.page.uri).to.eq("https://www.sitecore.com/products/content-cloud");
      })
      .its("response.statusCode")
      .should("eq", 201);
  });
});
